version: "0.3"
name: vault-init-auto
services:
   - name: dev
     image_name: sconecuratedimages/www2019:vault-1.5.0-alpine
     mrenclaves: [d1d5cc27d42702c33e1c4e9edb6347caa9924b3ddc773240ba7fc6d51481546a]
     command: /root/go/bin/vault-init dynamicsecret
     pwd: /
     environment:
        SCONE_MODE: hw
        PASSPHRASE1: $$SCONE::pasphrase1$$
   - name: dynamicsecret
     image_name: dynamicsecret-image
     mrenclaves: [d1d5cc27d42702c33e1c4e9edb6347caa9924b3ddc773240ba7fc6d51481546a]
     command: /root/go/bin/vault-init dynamicsecret
     pwd: /
     environment:
        SCONE_MODE: hw
        mongodb_password: $$SCONE::mongodb_password$$
        VAULT_TOKEN: $$SCONE::VAULT_TOKEN$$
   - name: generatesecret
     image_name: generatesecret-image
     mrenclaves: [d1d5cc27d42702c33e1c4e9edb6347caa9924b3ddc773240ba7fc6d51481546a]
     command: /root/go/bin/vault-init generatesecret
     pwd: /
     environment:
        SCONE_MODE: hw
        mongodb_password: $$SCONE::mongodb_password$$
        VAULT_TOKEN: $$SCONE::VAULT_TOKEN$$
secrets:
    - name: gpg_private_from_parent1
      import:
        session: demo-parent1
        secret: gpg_private_key1
    - name: gpg_public_from_parent1
      import:
        session: demo-parent1
        secret: gpg_public_key1
    - name: pasphrase1
      import:
        session: demo-parent1
        secret: pasphrase1
    - name: mongodb_password
      import:
        session: mongodb-user-setup
        secret: db_password
        
images:
    - name: sconecuratedimages/www2019:vault-1.5.0-alpine
      injection_files:
       - path: /root/go/bin/resources/vault/vault-experiments/keys/private.asc
         content: |
           $$SCONE::gpg_private_from_parent1$$
       - path: /root/go/bin/resources/vault/vault-experiments/keys/public.asc
         content: |
           $$SCONE::gpg_public_from_parent1$$
    
security:
  attestation:
    tolerate: [debug-mode, outdated-tcb]
    ignore_advisories: "*"
